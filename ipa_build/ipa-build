#!/bin/bash

# åŠŸèƒ½ï¼šç¼–è¯‘xcodeé¡¹ç›®å¹¶æ‰“ipaåŒ…
# ä½¿ç”¨è¯´æ˜ï¼š
# ç¼–è¯‘workspace
#			ipa-build  <workspace directory> -w -s <schemeName> [-c <project configuration>] [-n]
#
# å‚æ•°è¯´æ˜ï¼š	-c NAME				å·¥ç¨‹çš„configuration,é»˜è®¤ä¸ºReleaseã€‚  
#			-w					ç¼–è¯‘workspace	
#			-s NAME				å¯¹åº”workspaceä¸‹éœ€è¦ç¼–è¯‘çš„scheme
#			-n					ç¼–è¯‘å‰æ˜¯å¦å…ˆcleanå·¥ç¨‹
# è®¡æ—¶
SECONDS=0

if [ $# -lt 1 ];then
	echo "ä½ éœ€è¦æŠŠè¿™ä¸ªæ–‡ä»¶å¤¹æ”¾åˆ°å·¥ç¨‹æ ¹ç›®å½•ä¸‹è¾¹"
	exit 2
fi

if [ ! -d $1 ];then
	echo "ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªå·¥ç¨‹çš„è·¯å¾„"
	exit 2
fi

#å·¥ç¨‹ç»å¯¹è·¯å¾„
cd $1
project_path=$(pwd)

#ç¼–è¯‘çš„configurationï¼Œé»˜è®¤ä¸ºRelease
build_config=Release

param_pattern=":nc:ws:"
OPTIND=2
while getopts $param_pattern optname
  do
    case "$optname" in       
	  "n")        
		should_clean=y		
        ;;
      "c")        
		tmp_optind=$OPTIND
		tmp_optname=$optname
		tmp_optarg=$OPTARG
		OPTIND=$OPTIND-1
		if getopts $param_pattern optname ;then
			echo  "Error argument value for option $tmp_optname"
			exit 2
		fi
		OPTIND=$tmp_optind

		build_config=$tmp_optarg
		
        ;;
	  "w")
		workspace_name='*.xcworkspace'
		ls $project_path/$workspace_name &>/dev/null
		rtnValue=$?
		if [ $rtnValue = 0 ];then
			build_workspace=$(echo $(basename $project_path/$workspace_name))
		else
			echo  "Error!Current path is not a xcode workspace.Please check, or do not use -w option."
			exit 2
		fi
		
        ;;
	  "s")
		tmp_optind=$OPTIND
		tmp_optname=$optname
		tmp_optarg=$OPTARG

		OPTIND=$OPTIND-1
		if getopts $param_pattern optname ;then
			echo  "Error argument value for option $tmp_optname"
			exit 2
		fi
		OPTIND=$tmp_optind

		build_scheme=$tmp_optarg
		
        ;;
      "?")
        echo "Error! Unknown option $OPTARG"
		exit 2
        ;;
      ":")
        echo "Error! No argument value for option $OPTARG"
		exit 2
        ;;
      *)
      # Should not occur
        echo "Error! Unknown error while processing options"
		exit 2
        ;;
    esac
  done
# è¾“å‡ºåˆ°æ¡Œé¢
output_path=~/Desktop
# è·å–æ—¶é—´ å¦‚:201706011145
current_date="$(date +%Y%m%d_%H%M%S)"
# æŒ‡å®šè¾“å‡ºipaè·¯å¾„
export_path="${output_path}/${build_scheme}"
# æŒ‡å®šè¾“å‡ºå½’æ¡£æ–‡ä»¶åœ°å€
export_archive_path="${export_path}/${build_scheme}.xcarchive"
# æ‰“åŒ…é»˜è®¤è¾“å‡ºipaåœ°å€
export_ipa_path="${export_path}"
# plistæ–‡ä»¶åœ°å€
ExportOptionsPlistPath="./ExportOptions.plist"
# æŒ‡å®šè¾“å‡ºipaåœ°å€
output_ipa_path="${output_path}/${build_scheme}_${current_date}.ipa"
#æ˜¯å¦clean
if [ "$should_clean" = "y" ];then
	echo "æ¸…ç†å·¥ç¨‹~~~~~~~~~~~~~~~~"
	xcodebuild clean -configuration ${build_config} -workspace ${build_workspace} -scheme ${build_scheme} 
fi

#ç»„åˆç¼–è¯‘å‘½ä»¤
build_cmd='xcodebuild'

if [ "$build_workspace" != "" ];then
	#ç¼–è¯‘workspace
	if [ "$build_scheme" = "" ];then
		echo "Error! Must provide a scheme by -s option together when using -w option to compile a workspace."
		exit 2
	fi
	
	build_cmd=${build_cmd}' archive -workspace '${build_workspace}' -scheme '${build_scheme}' -configuration '${build_config}' -archivePath '${export_archive_path}' '

else
	echo "not workspace."
	
fi


#ç¼–è¯‘å·¥ç¨‹
cd $project_path
$build_cmd || exit


#æ‰“åŒ…
xcodebuild  -exportArchive  -archivePath ${export_archive_path}  -exportPath ${export_ipa_path}  -exportOptionsPlist ${ExportOptionsPlistPath} -allowProvisioningUpdates

echo "ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ${build_scheme} æ‰“åŒ…æˆåŠŸ! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  "

mv ${export_ipa_path}/Apps/${build_scheme}.ipa ${output_ipa_path}

echo "æ‰“åŒ…æ€»ç”¨æ—¶: ${SECONDS}s ~~~~~~~~~~~~~~~~"


#è¿›å…¥è¾“å‡ºè·¯å¾„ 
if [ "$export_path" != "" ];then
	rm -rf $export_path
fi

echo "åˆ é™¤æ‰€æœ‰ç¼–è¯‘æ–‡ä»¶"


echo "å…±è®¡æ€»ç”¨æ—¶: ${SECONDS}s ~~~~~~~~~~~~~~~~"
exit

