#!/bin/bash

# è·å–å·¥ç¨‹æ ¹ç›®å½•
fadir()  
{  
    local this_dir=`pwd`  
    local child_dir="$1" 
    dirname "$child_dir" 
    cd $this_dir  
} 
CUR_DIR=$(cd `dirname $0` && pwd -P )
PROJ_BIN=`fadir $CUR_DIR`
echo "å½“å‰æ–‡ä»¶è·¯å¾„ $CUR_DIR"
echo "å½“å‰æ–‡ä»¶è·¯å¾„ä¸Šä¸€çº§ $PROJ_BIN"

echo "

ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  å¼€å§‹æ‰“åŒ…Release! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  

"
#å·¥ç¨‹ç»å¯¹è·¯å¾„
cd $PROJ_BIN
project_path=$(pwd)
echo "å·¥ç¨‹è·¯å¾„ $project_path"
# è¾“å‡ºåˆ°æ¡Œé¢
output_path=~/Desktop
#è·å–å·¥ç¨‹é»˜è®¤schemeçš„åå­—ï¼ˆé»˜è®¤ä¸å·¥ç¨‹æ–‡ä»¶åå­—ç›¸åŒï¼‰
scheme_name=$(echo $(basename ./*.xcodeproj) | awk -F. '{print $1}')
# è·å–æ—¶é—´ å¦‚:201706011145
current_date="$(date +%Y%m%d_%H%M%S)"
# æŒ‡å®šè¾“å‡ºipaè·¯å¾„
export_path="${output_path}/${scheme_name}_${current_date}"
export_path_ipa="${export_path}/${scheme_name}.ipa" 

exportOptions_path="$project_path/APPStore.plist"

echo "è¾“å‡ºè·¯å¾„ $export_path_ipa"

fastlane gym --export_method app-store --output_name ${scheme_name} --scheme ${scheme_name} --clean --configuration Release --output_directory ${export_path} --export_options ${exportOptions_path} --export_xcargs -allowProvisioningUpdates

echo "æ‰“åŒ…æ€»ç”¨æ—¶: ${SECONDS}s ~~~~~~~~~~~~~~~~"
echo "

ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ${scheme_name}  æ‰“åŒ…å®Œæˆ! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  

"

if [ "$export_path_ipa" != "" ];then



echo "

ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  å¼€å§‹ä¸Šä¼ AppStore! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰

"
fastlane deliver --ipa $export_path_ipa --skip_screenshots --skip_metadata --force

echo "

ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  AppStoreä¸Šä¼ å®Œæˆ! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰ 

"
 
echo "å…±è®¡æ€»ç”¨æ—¶: ${SECONDS}s ~~~~~~~~~~~~~~~~"
fi

exit